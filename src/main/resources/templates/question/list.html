<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>试题管理 - 作业练习系统</title>
    <style>
        /* 基础重置样式 - 与系统统一 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", "微软雅黑", sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        /* 头部导航样式 - 与系统统一 */
        .header {
            background-color: #4CAF50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: normal;
        }
        
        /* 导航栏样式 - 与系统统一 */
        .header nav {
            display: flex;
            align-items: center;
        }
        
        .header nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
            margin: 0;
            padding: 0;
        }
        
        .header nav ul li a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
            font-size: 16px;
        }
        
        .header nav ul li a:hover, .header nav ul li a.active {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* 分页按钮样式 */
        .page-btn {
            margin: 0 3px;
            padding: 5px 10px;
            border: 1px solid #ddd;
            background-color: #fff;
            color: #333;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s ease;
        }
        
        .page-btn:hover:not(:disabled) {
            background-color: #f8f9fa;
            border-color: #4CAF50;
            color: #4CAF50;
        }
        
        .page-btn.active {
            background-color: #4CAF50 !important;
            color: white !important;
            border-color: #4CAF50 !important;
        }
        
        .page-btn:disabled {
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-info span {
            margin-right: 20px;
        }
        
        .logout-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
        }
        
        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        /* 容器样式 - 与系统统一 */
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        /* 卡片样式 - 与系统统一 */
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            margin: -25px -25px 20px -25px;
            font-size: 18px;
            font-weight: 600;
        }
        
        /* 按钮样式 - 与系统统一 */
        .btn {
            display: inline-block;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            text-decoration: none;
        }
        
        .btn:hover {
            background-color: #45a049;
        }
        
        .btn-danger {
            background-color: #f44336;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .btn-secondary {
            background-color: #9e9e9e;
        }
        
        .btn-secondary:hover {
            background-color: #757575;
        }
        
        /* 表单样式 */
        .form-control {
            display: block;
            width: 100%;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: 400;
            line-height: 1.5;
            color: #333;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        /* 输入组样式 */
        .input-group {
            display: flex;
            width: 100%;
        }
        
        .input-group .form-control {
            flex: 1;
            border-radius: 4px 0 0 4px;
        }
        
        .input-group .btn {
            border-radius: 0 4px 4px 0;
        }
        
        /* 表格样式 */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .table th,
        .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .table th {
            background-color: #f8f8f8;
            font-weight: 600;
            color: #333;
        }
        
        .table-striped tbody tr:nth-child(odd) {
            background-color: #f9f9f9;
        }
        
        /* 间距工具类 */
        .mt-3 { margin-top: 15px; }
        .mb-3 { margin-bottom: 15px; }
        .mb-4 { margin-bottom: 20px; }
        .mt-4 { margin-top: 20px; }
        .mr-2 { margin-right: 10px; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        
        /* 响应式网格 */
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }
        
        .col-md-4,
        .col-md-6,
        .col-md-8,
        .col-md-12 {
            padding: 0 10px;
            box-sizing: border-box;
        }
        
        @media (min-width: 768px) {
            .col-md-4 { width: 33.333%; }
            .col-md-6 { width: 50%; }
            .col-md-8 { width: 66.666%; }
            .col-md-12 { width: 100%; }
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h3 {
            color: #333;
            margin: 0;
        }
        
        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            text-align: right;
        }
        
        /* 选项卡样式 */
        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
            list-style: none;
            padding: 0;
        }
        
        .nav-tabs li {
            margin-right: 5px;
        }
        
        .nav-tabs button {
            background: none;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .nav-tabs button:hover {
            color: #4CAF50;
        }
        
        .nav-tabs button.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
            font-weight: 600;
        }
        
        /* 空状态样式 */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 15px;
            color: #ccc;
        }
        
        /* 运算符标签样式 */
        .operator-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 14px;
            color: white;
        }
        
        .operator-tag.add {
            background-color: #4CAF50;
        }
        
        .operator-tag.subtract {
            background-color: #ff9800;
        }
        
        .operator-tag.mixed {
            background-color: #2196F3;
        }
        
        /* 加载状态 */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        /* 页脚样式 - 与系统统一 */
        .footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 50px;
        }
        
        /* 表单组样式 */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
    </style>
</head>
<body>
    <!-- 头部导航 - 与系统统一 -->
    <header class="header">
        <h1>作业练习系统</h1>
        <nav>
            <ul>
                <li><a href="/index">首页</a></li>
                <li><a href="/student/list">学生管理</a></li>
                <li><a href="/question/list" class="active">试题管理</a></li>
                <li><a href="/assignment/list">作业管理</a></li>
                <li><a href="/score/list">成绩统计</a></li>
            </ul>
        </nav>
        <div class="user-info">
            <span>欢迎您，[[${teacher.name}]]</span>
            <a href="/logout" class="logout-btn">退出登录</a>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <div class="card-header">
                试题管理
            </div>
            
            <!-- 选项卡导航 -->
            <ul class="nav-tabs" id="questionTabs">
                <li>
                    <button class="active" id="questionList-tab" data-target="#questionList">试题列表</button>
                </li>
                <li>
                    <button id="generateQuestions-tab" data-target="#generateQuestions">生成随机试题</button>
                </li>
                <li>
                    <button id="addQuestion-tab" data-target="#addQuestion">手动添加试题</button>
                </li>
            </ul>
            
            <!-- 选项卡内容 -->
            <div class="tab-content" id="questionTabsContent">
                <!-- 试题列表 -->
                <div class="tab-content" id="questionList" style="display: block;">
                    <!-- 搜索功能 -->
                    <div class="input-group mt-3">
                        <input type="text" id="searchKeyword" class="form-control" placeholder="请输入题目内容关键词搜索...">
                        <button class="btn" onclick="searchQuestions()">搜索</button>
                        <button class="btn btn-secondary ml-2" onclick="refreshQuestions()">刷新列表</button>
                    </div>
                    
                    <!-- 试题表格 -->
                    <div class="loading" id="loadingIndicator">加载中...</div>
                    <table class="table table-striped mt-3" id="questionTable">
                        <thead>
                            <tr>
                                <th>题目序号</th>
                                <th>题目内容</th>
                                <th>正确答案</th>
                                <th>运算符</th>
                                <th>所属作业</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody id="questionTableBody">
                            <!-- 试题数据将通过JavaScript动态加载 -->
                        </tbody>
                    </table>
                    
                    <!-- 空状态提示 -->
                    <div class="empty-state" id="emptyState" style="display: none;">
                        <div class="icon">📝</div>
                        <h3>暂无试题</h3>
                        <p>您还没有创建任何试题，可以使用上方的功能生成或添加试题</p>
                    </div>
                    
                    <!-- 分页控件 -->
                    <div class="pagination-container" id="paginationContainer" style="margin-top: 20px; text-align: center; display: none;">
                        <div class="pagination-info" style="margin-bottom: 10px;">
                            共 <span id="totalItems">0</span> 条记录，第 <span id="currentPage">1</span>/<span id="totalPages">1</span> 页
                        </div>
                        <div class="pagination-controls">
                            <button class="btn btn-sm" id="prevPage" onclick="changePage(-1)" disabled>上一页</button>
                            <div class="page-numbers" id="pageNumbers" style="display: inline-block; margin: 0 10px;">
                                <!-- 页码按钮将动态生成 -->
                            </div>
                            <button class="btn btn-sm" id="nextPage" onclick="changePage(1)" disabled>下一页</button>
                        </div>
                        <div class="pagination-size" style="margin-top: 10px;">
                            <label>每页显示：</label>
                            <select id="pageSize" onchange="changePageSize()">
                                <option value="10" selected>10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- 生成随机试题 -->
                <div class="tab-content" id="generateQuestions" style="display: none;">
                    <form id="generateForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="questionCount">生成题目数量</label>
                                    <input type="number" id="questionCount" class="form-control" min="1" max="100" value="50">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="operatorType">运算符类型</label>
                                    <select id="operatorType" class="form-control">
                                        <option value="+">加法</option>
                                        <option value="-">减法</option>
                                        <option value="mixed">混合运算</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="numberMin">数值范围（最小值）</label>
                                    <input type="number" id="numberMin" class="form-control" min="0" value="1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="numberMax">数值范围（最大值）</label>
                                    <input type="number" id="numberMax" class="form-control" min="1" value="100">
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-4">
                            <button type="button" class="btn btn-lg" onclick="generateRandomQuestions()">生成随机试题</button>
                        </div>
                    </form>
                    
                    <!-- 生成结果预览 -->
                    <div class="mt-4" id="generateResult" style="display: none;">
                        <h4>生成结果</h4>
                        <div id="generatedQuestionsPreview"></div>
                    </div>
                </div>
                
                <!-- 手动添加试题 -->
                <div class="tab-content" id="addQuestion" style="display: none;">
                    <!-- 选项卡：单个添加和批量导入 -->
                    <div style="margin-bottom: 20px;">
                        <button id="singleAdd-tab" class="btn btn-secondary" onclick="showTab('singleAdd')">单个添加</button>
                        <button id="batchImport-tab" class="btn" onclick="showTab('batchImport')">批量导入</button>
                    </div>
                    
                    <!-- 单个添加试题 -->
                    <div id="singleAdd" class="import-tab-content">
                        <form id="addQuestionForm">
                            <div class="form-group">
                                <label for="questionContent">题目内容</label>
                                <input type="text" id="questionContent" class="form-control" placeholder="例如：5 + 3 = ?" required>
                            </div>
                            <div class="form-group">
                                <label for="questionAnswer">正确答案</label>
                                <input type="number" id="questionAnswer" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="questionOperator">运算符类型</label>
                                <select id="questionOperator" class="form-control">
                                    <option value="+">加法</option>
                                    <option value="-">减法</option>
                                    <option value="mixed">混合运算</option>
                                </select>
                            </div>
                            <div class="text-center mt-4">
                                <button type="button" class="btn btn-lg" onclick="addManualQuestion()">添加试题</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- 批量导入试题 -->
                    <div id="batchImport" class="import-tab-content" style="display: none;">
                        <div class="card">
                            <div class="card-header">CSV文件导入试题</div>
                            <div style="padding: 20px;">
                                <p class="description" style="color: #666; margin-bottom: 20px;">
                                    上传包含算式的CSV文件（格式要求：第一行为"expression"，后续每行一个算式，如"12+34=46"或"56-7=49"）
                                </p>
                                
                                <div class="file-upload" style="margin: 20px 0; padding: 20px; border: 2px dashed #ccc; border-radius: 8px; text-align: center; transition: border-color 0.3s;">
                                    <input type="file" id="batchCsvFileInput" accept=".csv" style="display: none;">
                                    <label for="batchCsvFileInput" style="cursor: pointer; color: #4CAF50; font-weight: bold; font-size: 16px;">点击选择CSV文件</label>
                                    <p id="batchFileName" style="margin-top: 10px;">未选择文件</p>
                                    <button id="batchVerifyCsvBtn" style="margin-top: 10px;" class="btn">验证试题</button>
                                </div>
                                
                                <div id="batchVerifyCsvResult" style="display: none; margin-top: 20px;">
                                    <div class="stats" style="font-size: 18px; margin-bottom: 15px; padding: 10px; background-color: #e9f7ef; border-radius: 4px;">
                                        总题数：<span id="batchTotalCount">0</span> | 
                                        做对：<span id="batchCorrectCount" style="color: #28a745;">0</span> | 
                                        做错：<span id="batchIncorrectCount" style="color: #dc3545;">0</span>
                                    </div>
                                    <div class="details" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px;"></div>
                                    <div class="text-center">
                                        <button id="saveCorrectQuestionsBtn" style="margin: 10px;" class="btn btn-lg">保存正确试题</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                

            </div>
        </div>
    </div>
    
    <!-- 确认删除模态框 -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>确认删除</h3>
            </div>
            <div>
                <p>确定要删除这道试题吗？此操作不可撤销。</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">取消</button>
                <button class="btn btn-danger" onclick="confirmDelete()">删除</button>
            </div>
        </div>
    </div>
    
    <!-- 页脚 - 与系统统一 -->
    <footer class="footer">
        <p>&copy; 作业练习系统 黑大帅</p>
    </footer>

    <!-- 内联JavaScript功能 -->
    <script>
        // 当前选中的试题ID（用于删除操作）
        let currentQuestionId = null;
        // 存储批量导入验证通过的试题
        let validQuestions = [];
        // 分页相关变量
        let currentPage = 1; // 当前页码
        let pageSize = 10; // 每页显示数量
        let totalItems = 0; // 总记录数
        let totalPages = 1; // 总页数
        let isSearchMode = false; // 是否处于搜索模式
        let searchKeyword = ''; // 搜索关键词
        // 存储作业ID到作业名称的映射
        let assignmentMap = {};

        // 初始化选项卡功能
        function initTabs() {
            const tabs = document.querySelectorAll('.nav-tabs button');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // 移除所有标签的活动状态
                    tabs.forEach(t => t.classList.remove('active'));
                    // 设置当前标签为活动状态
                    tab.classList.add('active');
                    
                    // 隐藏所有内容区域
                    const contentAreas = document.querySelectorAll('.tab-content');
                    contentAreas.forEach(area => {
                        if (area.id !== 'questionTabs' && area.id !== 'questionTabsContent') {
                            area.style.display = 'none';
                        }
                    });
                    
                    // 显示选中的内容区域
                    const target = tab.getAttribute('data-target');
                    const targetElement = document.querySelector(target);
                    if (targetElement) {
                        targetElement.style.display = 'block';
                    }
                });
            });
        }
        
        // 初始化函数
        function init() {
            initTabs();
            loadQuestions();
            
            // 初始化批量导入相关事件监听
            initBatchImportEvents();
        }
        
        // 初始化批量导入相关事件监听
        function initBatchImportEvents() {
            // 文件选择事件
            const batchFileInput = document.getElementById('batchCsvFileInput');
            if (batchFileInput) {
                batchFileInput.addEventListener('change', function() {
                    const fileName = this.files[0] ? this.files[0].name : '未选择文件';
                    document.getElementById('batchFileName').textContent = fileName;
                });
            }
            
            // 验证按钮点击事件
            const batchVerifyBtn = document.getElementById('batchVerifyCsvBtn');
            if (batchVerifyBtn) {
                batchVerifyBtn.addEventListener('click', verifyBatchCsv);
            }
            
            // 保存正确试题按钮点击事件
            const saveBtn = document.getElementById('saveCorrectQuestionsBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveCorrectQuestions);
            }
        }
        
        // 切换单个添加和批量导入选项卡
        function showTab(tabName) {
            // 隐藏所有选项卡内容
            const tabContents = document.querySelectorAll('.import-tab-content');
            tabContents.forEach(content => {
                content.style.display = 'none';
            });
            
            // 显示选中的选项卡内容
            document.getElementById(tabName).style.display = 'block';
            
            // 更新按钮样式
            document.getElementById('singleAdd-tab').className = 'btn ' + (tabName === 'singleAdd' ? 'btn-secondary' : '');
            document.getElementById('batchImport-tab').className = 'btn ' + (tabName === 'batchImport' ? 'btn-secondary' : '');
        }
        
        // 批量验证CSV文件
        function verifyBatchCsv() {
            const fileInput = document.getElementById('batchCsvFileInput');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('请选择CSV文件');
                return;
            }
            
            const file = fileInput.files[0];
            if (!file.name.endsWith('.csv')) {
                alert('请选择CSV格式的文件');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/verify', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // 清空之前的有效试题
                validQuestions = [];
                
                // 更新统计信息
                document.getElementById('batchTotalCount').textContent = data.total;
                document.getElementById('batchCorrectCount').textContent = data.correct;
                document.getElementById('batchIncorrectCount').textContent = data.incorrect;
                
                // 渲染详细结果
                const detailsContainer = document.querySelector('#batchVerifyCsvResult .details');
                detailsContainer.innerHTML = '';
                
                // 创建结果表格
                const table = document.createElement('table');
                table.className = 'table table-striped';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>算式</th>
                            <th>验证结果</th>
                            <th>备注</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                
                // 处理每个验证结果
                data.details.forEach(result => {
                    const row = document.createElement('tr');
                    if (result.correct) {
                        row.className = 'table-success';
                    } else {
                        row.className = ''; // 清空类以避免冲突
                        row.style.backgroundColor = '#ffe6e6'; // 淡红色背景
                        row.style.color = '#333'; // 深灰色文字，提高可读性
                        row.style.border = '1px solid #dee2e6'; // 保持表格边框
                    }
                    
                    // 存储正确的试题
                    if (result.correct) {
                        validQuestions.push({
                            expression: result.expression,
                            answer: result.expected
                        });
                    }
                    
                    // 构建备注信息
                    let message = '';
                    if (result.correct) {
                        message = '答案正确';
                    } else if (result.message) {
                        message = result.message;
                    } else {
                        message = `答案错误（正确答案：${result.expected}）`;
                    }
                    
                    row.innerHTML = `
                        <td>${result.expression}</td>
                        <td>${result.correct ? '正确' : '错误'}</td>
                        <td>${message}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                detailsContainer.appendChild(table);
                
                // 显示结果区域
                document.getElementById('batchVerifyCsvResult').style.display = 'block';
            })
            .catch(error => {
                console.error('验证失败:', error);
                alert('验证失败，请检查文件格式是否正确');
            });
        }
        
        // 保存正确试题到数据库
        function saveCorrectQuestions() {
            if (validQuestions.length === 0) {
                alert('没有可保存的正确试题');
                return;
            }
            
            fetch('/question/batchSave', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(validQuestions)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`成功保存 ${data.savedCount} 道试题`);
                    // 重置批量导入区域
                    document.getElementById('batchCsvFileInput').value = '';
                    document.getElementById('batchFileName').textContent = '未选择文件';
                    document.getElementById('batchVerifyCsvResult').style.display = 'none';
                    validQuestions = [];
                    // 刷新试题列表
                    loadQuestions();
                } else {
                    alert('保存失败: ' + (data.message || '未知错误'));
                }
            })
            .catch(error => {
                console.error('保存失败:', error);
                alert('保存失败，请稍后重试');
            });
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化
            init();
        });
        
        // 初始化选项卡功能
        function initTabs() {
            const tabButtons = document.querySelectorAll('.nav-tabs button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // 移除所有活动状态
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    // 只选择id为questionTabsContent下的tab-content元素
                    document.querySelectorAll('#questionTabsContent > .tab-content').forEach(pane => {
                        pane.style.display = 'none';
                    });
                    
                    // 添加当前活动状态
                    this.classList.add('active');
                    
                    const targetId = this.getAttribute('data-target').substring(1);
                    const targetPane = document.getElementById(targetId);
                    if (targetPane) {
                        targetPane.style.display = 'block';
                    }
                });
            });
        }
        
        // 加载作业信息映射
        function loadAssignmentMap() {
            return fetch('/assignment/getAll')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        data.data.forEach(assignment => {
                            assignmentMap[assignment.id] = assignment.title;
                        });
                    }
                    return assignmentMap;
                })
                .catch(error => {
                    console.error('加载作业信息失败:', error);
                    return {};
                });
        }
        
        // 加载试题列表（支持分页）
        function loadQuestions() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const questionTableBody = document.getElementById('questionTableBody');
            const emptyState = document.getElementById('emptyState');
            const paginationContainer = document.getElementById('paginationContainer');
            
            loadingIndicator.style.display = 'block';
            questionTableBody.innerHTML = '';
            paginationContainer.style.display = 'none';
            
            isSearchMode = false;
            
            // 先加载作业信息映射
            loadAssignmentMap().then(() => {
                // 使用fetch API从后端获取分页数据
                fetch(`/question/refresh?page=${currentPage}&pageSize=${pageSize}`)
                    .then(response => response.json())
                    .then(data => {
                        loadingIndicator.style.display = 'none';
                        
                        if (data.success && data.data) {
                            const questions = data.data.list || data.data;
                            totalItems = data.data.total || questions.length;
                            totalPages = Math.ceil(totalItems / pageSize);
                            
                            if (questions && questions.length > 0) {
                                // 隐藏空状态
                                emptyState.style.display = 'none';
                                paginationContainer.style.display = 'block';
                                
                                // 渲染试题列表
                                questions.forEach((question, index) => {
                                    const row = document.createElement('tr');
                                    
                                    // 运算符标签
                                    let operatorTag = '';
                                    if (question.operator === '+') {
                                        operatorTag = '<span class="operator-tag add">加法</span>';
                                    } else if (question.operator === '-') {
                                        operatorTag = '<span class="operator-tag subtract">减法</span>';
                                    } else if (question.operator === 'mixed') {
                                        operatorTag = '<span class="operator-tag mixed">混合运算</span>';
                                    }
                                    
                                    // 所属作业显示，使用作业名称代替ID
                                    let assignmentInfo = question.assignmentId == null || question.assignmentId === 0 || !assignmentMap[question.assignmentId] ? '暂未分配' : assignmentMap[question.assignmentId];
                                    
                                    // 计算正确的题目序号（考虑分页）
                                    const questionNumber = (currentPage - 1) * pageSize + index + 1;
                                    
                                    row.innerHTML = `
                                        <td>${questionNumber}</td>
                                        <td>${question.question}</td>
                                        <td>${question.answer}</td>
                                        <td>${operatorTag}</td>
                                        <td>${assignmentInfo}</td>
                                        <td>
                                            <button class="btn btn-danger" onclick="showDeleteModal(${question.id})">删除</button>
                                        </td>
                                    `;
                                    
                                    questionTableBody.appendChild(row);
                                });
                                
                                // 更新分页信息
                                updatePagination();
                            } else {
                                // 显示空状态
                                emptyState.style.display = 'block';
                            }
                        } else {
                            // 显示空状态
                            emptyState.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('加载试题列表失败:', error);
                        loadingIndicator.style.display = 'none';
                        emptyState.style.display = 'block';
                    });
            });
        }
        
        // 搜索试题（支持分页）
        function searchQuestions() {
            const keyword = document.getElementById('searchKeyword').value.trim();
            const loadingIndicator = document.getElementById('loadingIndicator');
            const questionTableBody = document.getElementById('questionTableBody');
            const emptyState = document.getElementById('emptyState');
            const paginationContainer = document.getElementById('paginationContainer');
            
            if (!keyword) {
                currentPage = 1;
                loadQuestions();
                return;
            }
            
            loadingIndicator.style.display = 'block';
            questionTableBody.innerHTML = '';
            paginationContainer.style.display = 'none';
            
            isSearchMode = true;
            searchKeyword = keyword;
            
            // 使用fetch API从后端获取分页搜索数据
            fetch(`/question/search?keyword=${encodeURIComponent(keyword)}&page=${currentPage}&pageSize=${pageSize}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                loadingIndicator.style.display = 'none';
                
                if (data.success && data.data) {
                    const questions = data.data.list || data.data;
                    totalItems = data.data.total || questions.length;
                    totalPages = Math.ceil(totalItems / pageSize);
                    
                    if (questions && questions.length > 0) {
                        emptyState.style.display = 'none';
                        paginationContainer.style.display = 'block';
                        
                        questions.forEach((question, index) => {
                            const row = document.createElement('tr');
                            
                            let operatorTag = '';
                            if (question.operator === '+') {
                                operatorTag = '<span class="operator-tag add">加法</span>';
                            } else if (question.operator === '-') {
                                operatorTag = '<span class="operator-tag subtract">减法</span>';
                            } else if (question.operator === 'mixed') {
                                operatorTag = '<span class="operator-tag mixed">混合运算</span>';
                            }
                           // 所属作业显示，使用作业名称代替ID
                            let assignmentInfo = question.assignmentId === 0 || question.assignmentId == null || !assignmentMap[question.assignmentId] ? '暂未分配' : assignmentMap[question.assignmentId];
                            
                            // 计算正确的题目序号（考虑分页）
                            const questionNumber = (currentPage - 1) * pageSize + index + 1;
                            
                            row.innerHTML = `
                                <td>${questionNumber}</td>
                                <td>${question.question}</td>
                                <td>${question.answer}</td>
                                <td>${operatorTag}</td>
                                <td>${assignmentInfo}</td>
                                <td>
                                    <button class="btn btn-danger" onclick="showDeleteModal(${question.id})"></button>
                                </td>
                            `;
                            
                            questionTableBody.appendChild(row);
                        });
                        
                        // 更新分页信息
                        updatePagination();
                    } else {
                        emptyState.style.display = 'block';
                        emptyState.innerHTML = `
                            <div class="icon">🔍</div>
                            <h3>未找到相关试题</h3>
                            <p>没有找到包含"${keyword}"的试题，请尝试其他关键词</p>
                        `;
                    }
                } else {
                    emptyState.style.display = 'block';
                    emptyState.innerHTML = `
                        <div class="icon">🔍</div>
                        <h3>未找到相关试题</h3>
                        <p>没有找到包含"${keyword}"的试题，请尝试其他关键词</p>
                    `;
                }
            })
            .catch(error => {
                console.error('搜索试题失败:', error);
                loadingIndicator.style.display = 'none';
            });
        }
        
        // 刷新试题列表
        function refreshQuestions() {
            document.getElementById('searchKeyword').value = '';
            currentPage = 1; // 重置到第一页
            isSearchMode = false;
            searchKeyword = '';
            loadQuestions();
        }
        
        // 更新分页控件
        function updatePagination() {
            const totalItemsElem = document.getElementById('totalItems');
            const currentPageElem = document.getElementById('currentPage');
            const totalPagesElem = document.getElementById('totalPages');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const pageNumbersDiv = document.getElementById('pageNumbers');
            
            // 更新分页信息文本
            totalItemsElem.textContent = totalItems;
            currentPageElem.textContent = currentPage;
            totalPagesElem.textContent = totalPages;
            
            // 更新上一页/下一页按钮状态
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
            
            // 生成页码按钮
            pageNumbersDiv.innerHTML = '';
            
            // 计算需要显示的页码范围
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            // 调整起始页码，确保显示5个页码
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            // 添加首页按钮
            if (startPage > 1) {
                addPageButton(1);
                if (startPage > 2) {
                    addEllipsis();
                }
            }
            
            // 添加中间页码按钮
            for (let i = startPage; i <= endPage; i++) {
                addPageButton(i);
            }
            
            // 添加末页按钮
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    addEllipsis();
                }
                addPageButton(totalPages);
            }
        }
        
        // 添加页码按钮
        function addPageButton(pageNum) {
            const pageNumbersDiv = document.getElementById('pageNumbers');
            const button = document.createElement('button');
            button.className = 'btn btn-sm page-btn';
            if (pageNum === currentPage) {
                button.classList.add('active');
                button.disabled = true;
            }
            button.textContent = pageNum;
            button.onclick = () => {
                currentPage = pageNum;
                if (isSearchMode) {
                    searchQuestions();
                } else {
                    loadQuestions();
                }
            };
            pageNumbersDiv.appendChild(button);
        }
        
        // 添加省略号
        function addEllipsis() {
            const pageNumbersDiv = document.getElementById('pageNumbers');
            const ellipsis = document.createElement('span');
            ellipsis.className = 'page-ellipsis';
            ellipsis.textContent = '...';
            ellipsis.style.margin = '0 5px';
            pageNumbersDiv.appendChild(ellipsis);
        }
        
        // 切换页面（-1: 上一页, 1: 下一页）
        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                if (isSearchMode) {
                    searchQuestions();
                } else {
                    loadQuestions();
                }
            }
        }
        
        // 改变每页显示数量
        function changePageSize() {
            const pageSizeSelect = document.getElementById('pageSize');
            pageSize = parseInt(pageSizeSelect.value);
            currentPage = 1; // 重置到第一页
            
            if (isSearchMode) {
                searchQuestions();
            } else {
                loadQuestions();
            }
        }
        
        // 生成随机试题
        function generateRandomQuestions() {
            const count = document.getElementById('questionCount').value;
            const operator = document.getElementById('operatorType').value;
            const min = document.getElementById('numberMin').value;
            const max = document.getElementById('numberMax').value;
            
            // 验证输入
            if (parseInt(min) >= parseInt(max)) {
                alert('最小值必须小于最大值');
                return;
            }
            
            // 显示加载状态
            const generateResult = document.getElementById('generateResult');
            const generatedQuestionsPreview = document.getElementById('generatedQuestionsPreview');
            generatedQuestionsPreview.innerHTML = '<div class="loading">正在生成试题...</div>';
            generateResult.style.display = 'block';
            
            // 发送请求
            fetch(`/question/generate?count=${count}&operator=${operator}&min=${min}&max=${max}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 保存生成的试题数据到页面，供后续保存使用
                    window.generatedQuestions = data.data;
                    
                    // 显示生成的试题预览（每行6个，直接显示答案）
                    let previewHtml = '<div class="card" style="margin-top: 20px;">';
                    previewHtml += '<div class="card-header" style="margin-bottom: 0;">生成的试题列表</div>';
                    previewHtml += '<div style="padding: 20px;">';
                    previewHtml += `<p>成功生成 ${data.data.length} 道试题</p>`;
                    
                    // 创建网格布局显示试题
                    previewHtml += '<div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 20px;">';
                    
                    data.data.forEach((question) => {
                        // 将问题格式化为 "5 + 3 = 8" 形式
                        const questionText = question.question.replace(' = ?', ` = ${question.answer}`);
                        previewHtml += `<div style="padding: 10px; border: 1px solid #eee; border-radius: 4px; text-align: center;">${questionText}</div>`;
                    });
                    
                    previewHtml += '</div>';
                    
                    previewHtml += '<div class="text-center mt-4">';
                    previewHtml += '<button class="btn" onclick="saveGeneratedQuestions()">保存试题</button>';
                    previewHtml += '<button class="btn btn-secondary ml-2" onclick="exportQuestionsToCSV()">导出试题</button>';
                    previewHtml += '</div>';
                    previewHtml += '</div>';
                    previewHtml += '</div>';
                    
                    generatedQuestionsPreview.innerHTML = previewHtml;
                } else {
                    generatedQuestionsPreview.innerHTML = `<div class="alert alert-danger">生成失败：${data.message}</div>`;
                }
            })
            .catch(error => {
                console.error('生成试题失败:', error);
                generatedQuestionsPreview.innerHTML = '<div class="alert alert-danger">生成失败，请稍后重试</div>';
            });
        }
        
        // 保存生成的试题到数据库
        function saveGeneratedQuestions() {
            if (!window.generatedQuestions || window.generatedQuestions.length === 0) {
                alert('没有可保存的试题');
                return;
            }
            
            const generatedQuestionsPreview = document.getElementById('generatedQuestionsPreview');
            generatedQuestionsPreview.innerHTML = '<div class="loading">正在保存试题...</div>';
            
            // 发送保存请求
            fetch('/question/saveGenerated', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    questions: window.generatedQuestions
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    generatedQuestionsPreview.innerHTML = `
                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header" style="margin-bottom: 0; background-color: #dff0d8; color: #3c763d;">
                                保存成功
                            </div>
                            <div style="padding: 20px;">
                                <p>成功保存 ${data.data} 道试题</p>
                                <div class="text-center mt-4">
                                    <button class="btn" onclick="loadQuestions(); switchToQuestionList();">查看所有试题</button>
                                </div>
                            </div>
                        </div>
                    `;
                    // 清空生成的试题数据
                    window.generatedQuestions = null;
                } else {
                    generatedQuestionsPreview.innerHTML = `<div class="alert alert-danger">保存失败：${data.message}</div>`;
                }
            })
            .catch(error => {
                console.error('保存试题失败:', error);
                generatedQuestionsPreview.innerHTML = '<div class="alert alert-danger">保存失败，请稍后重试</div>';
            });
        }
        
        // 手动添加试题
        function addManualQuestion() {
            const question = document.getElementById('questionContent').value.trim();
            const answer = document.getElementById('questionAnswer').value;
            const operator = document.getElementById('questionOperator').value;
            
            // 验证输入
            if (!question) {
                alert('请输入题目内容');
                return;
            }
            
            if (!answer) {
                alert('请输入正确答案');
                return;
            }
            
            // 发送请求
            fetch(`/question/add?question=${encodeURIComponent(question)}&answer=${answer}&operator=${operator}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('试题添加成功');
                    // 清空表单
                    document.getElementById('addQuestionForm').reset();
                    // 加载最新试题列表
                    loadQuestions();
                } else {
                    alert('添加失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('添加试题失败:', error);
                alert('添加失败，请稍后重试');
            });
        }
        
        // 显示删除确认模态框
        function showDeleteModal(id) {
            currentQuestionId = id;
            document.getElementById('deleteModal').style.display = 'block';
        }
        
        // 关闭删除确认模态框
        function closeDeleteModal() {
            currentQuestionId = null;
            document.getElementById('deleteModal').style.display = 'none';
        }
        
        // 确认删除试题
        function confirmDelete() {
            if (!currentQuestionId) return;
            
            fetch(`/question/delete/${currentQuestionId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                closeDeleteModal();
                if (data.success) {
                    alert('试题删除成功');
                    
                    // 检查当前页是否还有数据，如果没有则返回上一页
                    const questionTableBody = document.getElementById('questionTableBody');
                    const rows = questionTableBody.querySelectorAll('tr');
                    
                    // 如果当前页只有一条数据且不是第一页，则删除后返回上一页
                    if (rows.length === 1 && currentPage > 1) {
                        currentPage--;
                    }
                    
                    // 根据当前模式刷新数据
                    if (isSearchMode) {
                        searchQuestions();
                    } else {
                        loadQuestions();
                    }
                } else {
                    alert('删除失败：' + data.message);
                }
            })
            .catch(error => {
                console.error('删除试题失败:', error);
                closeDeleteModal();
                alert('删除失败，请稍后重试');
            });
        }
        

        
        // 切换到试题列表选项卡
        function switchToQuestionList() {
            document.querySelectorAll('.nav-tabs button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('questionList-tab').classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(pane => {
                pane.style.display = 'none';
            });
            document.getElementById('questionList').style.display = 'block';
        }
        

        

        
        // 导出试题为CSV文件
        function exportQuestionsToCSV() {
            if (!window.generatedQuestions || window.generatedQuestions.length === 0) {
                alert('没有可导出的试题');
                return;
            }
            
            // 创建CSV内容，第一行为表头
            let csvContent = 'expression\n';
            
            // 添加每个试题的表达式
            window.generatedQuestions.forEach(question => {
                // 将问题格式化为 "12+34=46" 形式，并移除空格
                const expression = question.question.replace(' = ?', ` = ${question.answer}`).replace(/\s+/g, '');
                csvContent += expression + '\n';
            });
            
            // 创建Blob对象
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // 创建下载链接
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // 设置文件名
            const filename = `questions_${new Date().getTime()}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>