<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¯•é¢˜ç®¡ç† - ä½œä¸šç»ƒä¹ ç³»ç»Ÿ</title>
    <style>
        /* åŸºç¡€é‡ç½®æ ·å¼ - ä¸ç³»ç»Ÿç»Ÿä¸€ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: "Microsoft YaHei", "å¾®è½¯é›…é»‘", sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .header {
            background-color: #4CAF50;
            color: white;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 24px;
            font-weight: normal;
        }

        /* å¯¼èˆªæ æ ·å¼ */
        .header nav {
            display: flex;
            align-items: center;
        }

        .header nav ul {
            display: flex;
            list-style: none;
            gap: 20px;
            margin: 0;
            padding: 0;
        }

        .header nav ul li a {
            color: white;
            text-decoration: none;
            padding: 8px 15px;
            border-radius: 4px;
            transition: background-color 0.3s;
            font-size: 16px;
        }

        .header nav ul li a:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .user-info span {
            margin-right: 20px;
        }

        .logout-btn {
            background-color: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            text-decoration: none;
        }

        .logout-btn:hover {
            background-color: rgba(255, 255, 255, 0.3);
        }
        
        /* å®¹å™¨æ ·å¼ - ä¸ç³»ç»Ÿç»Ÿä¸€ */
        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }
        
        /* å¡ç‰‡æ ·å¼ - ä¸ç³»ç»Ÿç»Ÿä¸€ */
        .card {
            background-color: white;
            border-radius: 8px;
            padding: 25px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            background-color: #4CAF50;
            color: white;
            padding: 15px 20px;
            border-radius: 8px 8px 0 0;
            margin: -25px -25px 20px -25px;
            font-size: 18px;
            font-weight: 600;
        }
        
        /* æŒ‰é’®æ ·å¼ - ä¸ç³»ç»Ÿç»Ÿä¸€ */
        .btn {
            display: inline-block;
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            transition: background-color 0.3s;
            text-decoration: none;
        }
        
        .btn:hover {
            background-color: #45a049;
        }
        
        .btn-danger {
            background-color: #f44336;
        }
        
        .btn-danger:hover {
            background-color: #d32f2f;
        }
        
        .btn-secondary {
            background-color: #9e9e9e;
        }
        
        .btn-secondary:hover {
            background-color: #757575;
        }
        
        /* è¡¨å•æ ·å¼ */
        .form-control {
            display: block;
            width: 100%;
            padding: 10px 15px;
            font-size: 16px;
            font-weight: 400;
            line-height: 1.5;
            color: #333;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 4px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #4CAF50;
        }
        
        /* è¾“å…¥ç»„æ ·å¼ */
        .input-group {
            display: flex;
            width: 100%;
        }
        
        .input-group .form-control {
            flex: 1;
            border-radius: 4px 0 0 4px;
        }
        
        .input-group .btn {
            border-radius: 0 4px 4px 0;
        }
        
        /* è¡¨æ ¼æ ·å¼ */
        .table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        
        .table th,
        .table td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        .table th {
            background-color: #f8f8f8;
            font-weight: 600;
            color: #333;
        }
        
        .table-striped tbody tr:nth-child(odd) {
            background-color: #f9f9f9;
        }
        
        /* é—´è·å·¥å…·ç±» */
        .mt-3 { margin-top: 15px; }
        .mb-3 { margin-bottom: 15px; }
        .mb-4 { margin-bottom: 20px; }
        .mt-4 { margin-top: 20px; }
        .mr-2 { margin-right: 10px; }
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        
        /* å“åº”å¼ç½‘æ ¼ */
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }
        
        .col-md-4,
        .col-md-6,
        .col-md-8,
        .col-md-12 {
            padding: 0 10px;
            box-sizing: border-box;
        }
        
        @media (min-width: 768px) {
            .col-md-4 { width: 33.333%; }
            .col-md-6 { width: 50%; }
            .col-md-8 { width: 66.666%; }
            .col-md-12 { width: 100%; }
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h3 {
            color: #333;
            margin: 0;
        }
        
        .modal-footer {
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            text-align: right;
        }
        
        /* é€‰é¡¹å¡æ ·å¼ */
        .nav-tabs {
            display: flex;
            border-bottom: 2px solid #eee;
            margin-bottom: 20px;
            list-style: none;
            padding: 0;
        }
        
        .nav-tabs li {
            margin-right: 5px;
        }
        
        .nav-tabs button {
            background: none;
            border: none;
            padding: 12px 20px;
            font-size: 16px;
            cursor: pointer;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .nav-tabs button:hover {
            color: #4CAF50;
        }
        
        .nav-tabs button.active {
            color: #4CAF50;
            border-bottom-color: #4CAF50;
            font-weight: 600;
        }
        
        /* ç©ºçŠ¶æ€æ ·å¼ */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }
        
        .empty-state .icon {
            font-size: 4rem;
            margin-bottom: 15px;
            color: #ccc;
        }
        
        /* è¿ç®—ç¬¦æ ‡ç­¾æ ·å¼ */
        .operator-tag {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 4px;
            font-size: 14px;
            color: white;
        }
        
        .operator-tag.add {
            background-color: #4CAF50;
        }
        
        .operator-tag.subtract {
            background-color: #ff9800;
        }
        
        .operator-tag.mixed {
            background-color: #2196F3;
        }
        
        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        /* é¡µè„šæ ·å¼ - ä¸ç³»ç»Ÿç»Ÿä¸€ */
        .footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 20px;
            margin-top: 50px;
        }
        
        /* è¡¨å•ç»„æ ·å¼ */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: #333;
        }
    </style>
</head>
<body>
    <!-- å¤´éƒ¨å¯¼èˆª - ä¸ç³»ç»Ÿç»Ÿä¸€ -->
    <header class="header">
        <h1>ä½œä¸šç»ƒä¹ ç³»ç»Ÿ</h1>
        <nav>
            <ul>
                <li><a href="/index">é¦–é¡µ</a></li>
                <li><a href="/student/list">å­¦ç”Ÿç®¡ç†</a></li>
                <li><a href="/question/list" class="active">è¯•é¢˜ç®¡ç†</a></li>
                <li><a href="/assignment/list">ä½œä¸šç®¡ç†</a></li>
                <li><a href="/exam/list">è€ƒè¯•ç®¡ç†</a></li>
                <li><a href="/score/list">æˆç»©ç»Ÿè®¡</a></li>
            </ul>
        </nav>
        <div class="user-info">
            <span>æ¬¢è¿æ‚¨ï¼Œ[[${teacher.name}]]</span>
            <a href="/logout" class="logout-btn">é€€å‡ºç™»å½•</a>
        </div>
    </header>

    <div class="container">
        <div class="card">
            <div class="card-header">
                è¯•é¢˜ç®¡ç†
            </div>
            
            <!-- é€‰é¡¹å¡å¯¼èˆª -->
            <ul class="nav-tabs" id="questionTabs">
                <li>
                    <button class="active" id="questionList-tab" data-target="#questionList">è¯•é¢˜åˆ—è¡¨</button>
                </li>
                <li>
                    <button id="generateQuestions-tab" data-target="#generateQuestions">ç”Ÿæˆéšæœºè¯•é¢˜</button>
                </li>
                <li>
                    <button id="addQuestion-tab" data-target="#addQuestion">æ‰‹åŠ¨æ·»åŠ è¯•é¢˜</button>
                </li>
            </ul>
            
            <!-- é€‰é¡¹å¡å†…å®¹ -->
            <div class="tab-content" id="questionTabsContent">
                <!-- è¯•é¢˜åˆ—è¡¨ -->
                <div class="tab-content" id="questionList" style="display: block;">
                    <!-- æœç´¢åŠŸèƒ½ -->
                    <div class="input-group mt-3">
                        <input type="text" id="searchKeyword" class="form-control" placeholder="è¯·è¾“å…¥é¢˜ç›®å†…å®¹å…³é”®è¯æœç´¢...">
                        <button class="btn" onclick="searchQuestions()">æœç´¢</button>
                        <button class="btn btn-secondary ml-2" onclick="refreshQuestions()">åˆ·æ–°åˆ—è¡¨</button>
                    </div>
                    
                    <!-- è¯•é¢˜è¡¨æ ¼ -->
                    <div class="loading" id="loadingIndicator">åŠ è½½ä¸­...</div>
                    <table class="table table-striped mt-3" id="questionTable">
                        <thead>
                            <tr>
                                <th>é¢˜ç›®åºå·</th>
                                <th>é¢˜ç›®å†…å®¹</th>
                                <th>æ­£ç¡®ç­”æ¡ˆ</th>
                                <th>è¿ç®—ç¬¦</th>
                                <th>æ‰€å±ä½œä¸š</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="questionTableBody">
                            <!-- è¯•é¢˜æ•°æ®å°†é€šè¿‡JavaScriptåŠ¨æ€åŠ è½½ -->
                        </tbody>
                    </table>
                    
                    <!-- ç©ºçŠ¶æ€æç¤º -->
                    <div class="empty-state" id="emptyState" style="display: none;">
                        <div class="icon">ğŸ“</div>
                        <h3>æš‚æ— è¯•é¢˜</h3>
                        <p>æ‚¨è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•è¯•é¢˜ï¼Œå¯ä»¥ä½¿ç”¨ä¸Šæ–¹çš„åŠŸèƒ½ç”Ÿæˆæˆ–æ·»åŠ è¯•é¢˜</p>
                    </div>
                    
                    <!-- åˆ†é¡µæ§ä»¶ -->
                    <div class="pagination-container" id="paginationContainer" style="margin-top: 20px; text-align: center; display: none;">
                        <div class="pagination-info" style="margin-bottom: 10px;">
                            å…± <span id="totalItems">0</span> æ¡è®°å½•ï¼Œç¬¬ <span id="currentPage">1</span>/<span id="totalPages">1</span> é¡µ
                        </div>
                        <div class="pagination-controls">
                            <button class="btn btn-sm" id="prevPage" onclick="changePage(-1)" disabled>ä¸Šä¸€é¡µ</button>
                            <div class="page-numbers" id="pageNumbers" style="display: inline-block; margin: 0 10px;">
                                <!-- é¡µç æŒ‰é’®å°†åŠ¨æ€ç”Ÿæˆ -->
                            </div>
                            <button class="btn btn-sm" id="nextPage" onclick="changePage(1)" disabled>ä¸‹ä¸€é¡µ</button>
                        </div>
                        <div class="pagination-size" style="margin-top: 10px;">
                            <label>æ¯é¡µæ˜¾ç¤ºï¼š</label>
                            <select id="pageSize" onchange="changePageSize()">
                                <option value="5" selected>5</option>
                                <option value="10">10</option>
                                <option value="20">20</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                            </select>
                        </div>
                    </div>
                </div>
                
                <!-- ç”Ÿæˆéšæœºè¯•é¢˜ -->
                <div class="tab-content" id="generateQuestions" style="display: none;">
                    <form id="generateForm">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="questionCount">ç”Ÿæˆé¢˜ç›®æ•°é‡</label>
                                    <input type="number" id="questionCount" class="form-control" min="1" max="100" value="50">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="operatorType">è¿ç®—ç¬¦ç±»å‹</label>
                                    <select id="operatorType" class="form-control">
                                        <option value="+">åŠ æ³•</option>
                                        <option value="-">å‡æ³•</option>
                                        <option value="mixed">æ··åˆè¿ç®—</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="numberMin">æ•°å€¼èŒƒå›´ï¼ˆæœ€å°å€¼ï¼‰</label>
                                    <input type="number" id="numberMin" class="form-control" min="0" value="1">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="numberMax">æ•°å€¼èŒƒå›´ï¼ˆæœ€å¤§å€¼ï¼‰</label>
                                    <input type="number" id="numberMax" class="form-control" min="1" value="100">
                                </div>
                            </div>
                        </div>
                        <div class="text-center mt-4">
                            <button type="button" class="btn btn-lg" onclick="generateRandomQuestions()">ç”Ÿæˆéšæœºè¯•é¢˜</button>
                        </div>
                    </form>
                    
                    <!-- ç”Ÿæˆç»“æœé¢„è§ˆ -->
                    <div class="mt-4" id="generateResult" style="display: none;">
                        <h4>ç”Ÿæˆç»“æœ</h4>
                        <div id="generatedQuestionsPreview"></div>
                    </div>
                </div>
                
                <!-- æ‰‹åŠ¨æ·»åŠ è¯•é¢˜ -->
                <div class="tab-content" id="addQuestion" style="display: none;">
                    <!-- é€‰é¡¹å¡ï¼šå•ä¸ªæ·»åŠ å’Œæ‰¹é‡å¯¼å…¥ -->
                    <div style="margin-bottom: 20px;">
                        <button id="singleAdd-tab" class="btn btn-secondary" onclick="showTab('singleAdd')">å•ä¸ªæ·»åŠ </button>
                        <button id="batchImport-tab" class="btn" onclick="showTab('batchImport')">æ‰¹é‡å¯¼å…¥</button>
                    </div>
                    
                    <!-- å•ä¸ªæ·»åŠ è¯•é¢˜ -->
                    <div id="singleAdd" class="import-tab-content">
                        <form id="addQuestionForm">
                            <div class="form-group">
                                <label for="questionContent">é¢˜ç›®å†…å®¹</label>
                                <input type="text" id="questionContent" class="form-control" placeholder="ä¾‹å¦‚ï¼š5 + 3 = ?" required>
                            </div>
                            <div class="form-group">
                                <label for="questionAnswer">æ­£ç¡®ç­”æ¡ˆ</label>
                                <input type="number" id="questionAnswer" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label for="questionOperator">è¿ç®—ç¬¦ç±»å‹</label>
                                <select id="questionOperator" class="form-control">
                                    <option value="+">åŠ æ³•</option>
                                    <option value="-">å‡æ³•</option>
                                    <option value="mixed">æ··åˆè¿ç®—</option>
                                </select>
                            </div>
                            <div class="text-center mt-4">
                                <button type="button" class="btn btn-lg" onclick="addManualQuestion()">æ·»åŠ è¯•é¢˜</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- æ‰¹é‡å¯¼å…¥è¯•é¢˜ -->
                    <div id="batchImport" class="import-tab-content" style="display: none;">
                        <div class="card">
                            <div class="card-header">CSVæ–‡ä»¶å¯¼å…¥è¯•é¢˜</div>
                            <div style="padding: 20px;">
                                <p class="description" style="color: #666; margin-bottom: 20px;">
                                    ä¸Šä¼ åŒ…å«ç®—å¼çš„CSVæ–‡ä»¶ï¼ˆæ ¼å¼è¦æ±‚ï¼šç¬¬ä¸€è¡Œä¸º"expression"ï¼Œåç»­æ¯è¡Œä¸€ä¸ªç®—å¼ï¼Œå¦‚"12+34=46"æˆ–"56-7=49"ï¼‰
                                </p>
                                
                                <div class="file-upload" style="margin: 20px 0; padding: 20px; border: 2px dashed #ccc; border-radius: 8px; text-align: center; transition: border-color 0.3s;">
                                    <input type="file" id="batchCsvFileInput" accept=".csv" style="display: none;">
                                    <label for="batchCsvFileInput" style="cursor: pointer; color: #4CAF50; font-weight: bold; font-size: 16px;">ç‚¹å‡»é€‰æ‹©CSVæ–‡ä»¶</label>
                                    <p id="batchFileName" style="margin-top: 10px;">æœªé€‰æ‹©æ–‡ä»¶</p>
                                    <button id="batchVerifyCsvBtn" style="margin-top: 10px;" class="btn">éªŒè¯è¯•é¢˜</button>
                                </div>
                                
                                <div id="batchVerifyCsvResult" style="display: none; margin-top: 20px;">
                                    <div class="stats" style="font-size: 18px; margin-bottom: 15px; padding: 10px; background-color: #e9f7ef; border-radius: 4px;">
                                        æ€»é¢˜æ•°ï¼š<span id="batchTotalCount">0</span> | 
                                        åšå¯¹ï¼š<span id="batchCorrectCount" style="color: #28a745;">0</span> | 
                                        åšé”™ï¼š<span id="batchIncorrectCount" style="color: #dc3545;">0</span>
                                    </div>
                                    <div class="details" style="max-height: 300px; overflow-y: auto; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 20px;"></div>
                                    <div class="text-center">
                                        <button id="saveCorrectQuestionsBtn" style="margin: 10px;" class="btn btn-lg">ä¿å­˜æ­£ç¡®è¯•é¢˜</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                

            </div>
        </div>
    </div>
    
    <!-- ç¡®è®¤åˆ é™¤æ¨¡æ€æ¡† -->
    <div class="modal" id="deleteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ç¡®è®¤åˆ é™¤</h3>
            </div>
            <div>
                <p>ç¡®å®šè¦åˆ é™¤è¿™é“è¯•é¢˜å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeDeleteModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="confirmDelete()">åˆ é™¤</button>
            </div>
        </div>
    </div>
    
    <!-- é¡µè„š - ä¸ç³»ç»Ÿç»Ÿä¸€ -->
<!--    <footer class="footer">-->
<!--        <p>&copy; ä½œä¸šç»ƒä¹ ç³»ç»Ÿ é»‘å¤§å¸…</p>-->
<!--    </footer>-->

    <!-- å†…è”JavaScriptåŠŸèƒ½ -->
    <script>
        // å½“å‰é€‰ä¸­çš„è¯•é¢˜IDï¼ˆç”¨äºåˆ é™¤æ“ä½œï¼‰
        let currentQuestionId = null;
        // å­˜å‚¨æ‰¹é‡å¯¼å…¥éªŒè¯é€šè¿‡çš„è¯•é¢˜
        let validQuestions = [];
        // åˆ†é¡µç›¸å…³å˜é‡
        let currentPage = 1; // å½“å‰é¡µç 
        let pageSize = 5; // æ¯é¡µæ˜¾ç¤ºæ•°é‡
        let totalItems = 0; // æ€»è®°å½•æ•°
        let totalPages = 1; // æ€»é¡µæ•°
        let isSearchMode = false; // æ˜¯å¦å¤„äºæœç´¢æ¨¡å¼
        let searchKeyword = ''; // æœç´¢å…³é”®è¯
        // å­˜å‚¨ä½œä¸šIDåˆ°ä½œä¸šåç§°çš„æ˜ å°„
        let assignmentMap = {};

        // åˆå§‹åŒ–é€‰é¡¹å¡åŠŸèƒ½
        function initTabs() {
            const tabs = document.querySelectorAll('.nav-tabs button');
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    // ç§»é™¤æ‰€æœ‰æ ‡ç­¾çš„æ´»åŠ¨çŠ¶æ€
                    tabs.forEach(t => t.classList.remove('active'));
                    // è®¾ç½®å½“å‰æ ‡ç­¾ä¸ºæ´»åŠ¨çŠ¶æ€
                    tab.classList.add('active');
                    
                    // éšè—æ‰€æœ‰å†…å®¹åŒºåŸŸ
                    const contentAreas = document.querySelectorAll('.tab-content');
                    contentAreas.forEach(area => {
                        if (area.id !== 'questionTabs' && area.id !== 'questionTabsContent') {
                            area.style.display = 'none';
                        }
                    });
                    
                    // æ˜¾ç¤ºé€‰ä¸­çš„å†…å®¹åŒºåŸŸ
                    const target = tab.getAttribute('data-target');
                    const targetElement = document.querySelector(target);
                    if (targetElement) {
                        targetElement.style.display = 'block';
                    }
                });
            });
        }
        
        // åˆå§‹åŒ–å‡½æ•°
        function init() {
            initTabs();
            loadQuestions();
            
            // åˆå§‹åŒ–æ‰¹é‡å¯¼å…¥ç›¸å…³äº‹ä»¶ç›‘å¬
            initBatchImportEvents();
        }
        
        // åˆå§‹åŒ–æ‰¹é‡å¯¼å…¥ç›¸å…³äº‹ä»¶ç›‘å¬
        function initBatchImportEvents() {
            // æ–‡ä»¶é€‰æ‹©äº‹ä»¶
            const batchFileInput = document.getElementById('batchCsvFileInput');
            if (batchFileInput) {
                batchFileInput.addEventListener('change', function() {
                    const fileName = this.files[0] ? this.files[0].name : 'æœªé€‰æ‹©æ–‡ä»¶';
                    document.getElementById('batchFileName').textContent = fileName;
                });
            }
            
            // éªŒè¯æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            const batchVerifyBtn = document.getElementById('batchVerifyCsvBtn');
            if (batchVerifyBtn) {
                batchVerifyBtn.addEventListener('click', verifyBatchCsv);
            }
            
            // ä¿å­˜æ­£ç¡®è¯•é¢˜æŒ‰é’®ç‚¹å‡»äº‹ä»¶
            const saveBtn = document.getElementById('saveCorrectQuestionsBtn');
            if (saveBtn) {
                saveBtn.addEventListener('click', saveCorrectQuestions);
            }
        }
        
        // åˆ‡æ¢å•ä¸ªæ·»åŠ å’Œæ‰¹é‡å¯¼å…¥é€‰é¡¹å¡
        function showTab(tabName) {
            // éšè—æ‰€æœ‰é€‰é¡¹å¡å†…å®¹
            const tabContents = document.querySelectorAll('.import-tab-content');
            tabContents.forEach(content => {
                content.style.display = 'none';
            });
            
            // æ˜¾ç¤ºé€‰ä¸­çš„é€‰é¡¹å¡å†…å®¹
            document.getElementById(tabName).style.display = 'block';
            
            // æ›´æ–°æŒ‰é’®æ ·å¼
            document.getElementById('singleAdd-tab').className = 'btn ' + (tabName === 'singleAdd' ? 'btn-secondary' : '');
            document.getElementById('batchImport-tab').className = 'btn ' + (tabName === 'batchImport' ? 'btn-secondary' : '');
        }
        
        // æ‰¹é‡éªŒè¯CSVæ–‡ä»¶
        function verifyBatchCsv() {
            const fileInput = document.getElementById('batchCsvFileInput');
            if (!fileInput.files || fileInput.files.length === 0) {
                alert('è¯·é€‰æ‹©CSVæ–‡ä»¶');
                return;
            }
            
            const file = fileInput.files[0];
            if (!file.name.endsWith('.csv')) {
                alert('è¯·é€‰æ‹©CSVæ ¼å¼çš„æ–‡ä»¶');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            fetch('/verify', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                // æ¸…ç©ºä¹‹å‰çš„æœ‰æ•ˆè¯•é¢˜
                validQuestions = [];
                
                // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
                document.getElementById('batchTotalCount').textContent = data.total;
                document.getElementById('batchCorrectCount').textContent = data.correct;
                document.getElementById('batchIncorrectCount').textContent = data.incorrect;
                
                // æ¸²æŸ“è¯¦ç»†ç»“æœ
                const detailsContainer = document.querySelector('#batchVerifyCsvResult .details');
                detailsContainer.innerHTML = '';
                
                // åˆ›å»ºç»“æœè¡¨æ ¼
                const table = document.createElement('table');
                table.className = 'table table-striped';
                table.innerHTML = `
                    <thead>
                        <tr>
                            <th>ç®—å¼</th>
                            <th>éªŒè¯ç»“æœ</th>
                            <th>å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody>
                    </tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                
                // å¤„ç†æ¯ä¸ªéªŒè¯ç»“æœ
                data.details.forEach(result => {
                    const row = document.createElement('tr');
                    if (result.correct) {
                        row.className = 'table-success';
                    } else {
                        row.className = ''; // æ¸…ç©ºç±»ä»¥é¿å…å†²çª
                        row.style.backgroundColor = '#ffe6e6'; // æ·¡çº¢è‰²èƒŒæ™¯
                        row.style.color = '#333'; // æ·±ç°è‰²æ–‡å­—ï¼Œæé«˜å¯è¯»æ€§
                        row.style.border = '1px solid #dee2e6'; // ä¿æŒè¡¨æ ¼è¾¹æ¡†
                    }
                    
                    // å­˜å‚¨æ­£ç¡®çš„è¯•é¢˜
                    if (result.correct) {
                        validQuestions.push({
                            expression: result.expression,
                            answer: result.expected
                        });
                    }
                    
                    // æ„å»ºå¤‡æ³¨ä¿¡æ¯
                    let message = '';
                    if (result.correct) {
                        message = 'ç­”æ¡ˆæ­£ç¡®';
                    } else if (result.message) {
                        message = result.message;
                    } else {
                        message = `ç­”æ¡ˆé”™è¯¯ï¼ˆæ­£ç¡®ç­”æ¡ˆï¼š${result.expected}ï¼‰`;
                    }
                    
                    row.innerHTML = `
                        <td>${result.expression}</td>
                        <td>${result.correct ? 'æ­£ç¡®' : 'é”™è¯¯'}</td>
                        <td>${message}</td>
                    `;
                    tbody.appendChild(row);
                });
                
                detailsContainer.appendChild(table);
                
                // æ˜¾ç¤ºç»“æœåŒºåŸŸ
                document.getElementById('batchVerifyCsvResult').style.display = 'block';
            })
            .catch(error => {
                console.error('éªŒè¯å¤±è´¥:', error);
                alert('éªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ ¼å¼æ˜¯å¦æ­£ç¡®');
            });
        }
        
        // ä¿å­˜æ­£ç¡®è¯•é¢˜åˆ°æ•°æ®åº“
        function saveCorrectQuestions() {
            if (validQuestions.length === 0) {
                alert('æ²¡æœ‰å¯ä¿å­˜çš„æ­£ç¡®è¯•é¢˜');
                return;
            }
            
            fetch('/question/batchSave', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(validQuestions)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert(`æˆåŠŸä¿å­˜ ${data.savedCount} é“è¯•é¢˜`);
                    // é‡ç½®æ‰¹é‡å¯¼å…¥åŒºåŸŸ
                    document.getElementById('batchCsvFileInput').value = '';
                    document.getElementById('batchFileName').textContent = 'æœªé€‰æ‹©æ–‡ä»¶';
                    document.getElementById('batchVerifyCsvResult').style.display = 'none';
                    validQuestions = [];
                    // åˆ·æ–°è¯•é¢˜åˆ—è¡¨
                    loadQuestions();
                } else {
                    alert('ä¿å­˜å¤±è´¥: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            })
            .catch(error => {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–
            init();
        });
        
        // åˆå§‹åŒ–é€‰é¡¹å¡åŠŸèƒ½
        function initTabs() {
            const tabButtons = document.querySelectorAll('.nav-tabs button');
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    // åªé€‰æ‹©idä¸ºquestionTabsContentä¸‹çš„tab-contentå…ƒç´ 
                    document.querySelectorAll('#questionTabsContent > .tab-content').forEach(pane => {
                        pane.style.display = 'none';
                    });
                    
                    // æ·»åŠ å½“å‰æ´»åŠ¨çŠ¶æ€
                    this.classList.add('active');
                    
                    const targetId = this.getAttribute('data-target').substring(1);
                    const targetPane = document.getElementById(targetId);
                    if (targetPane) {
                        targetPane.style.display = 'block';
                    }
                });
            });
        }
        
        // åŠ è½½ä½œä¸šä¿¡æ¯æ˜ å°„
        function loadAssignmentMap() {
            return fetch('/assignment/getAll')
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        data.data.forEach(assignment => {
                            assignmentMap[assignment.id] = assignment.title;
                        });
                    }
                    return assignmentMap;
                })
                .catch(error => {
                    console.error('åŠ è½½ä½œä¸šä¿¡æ¯å¤±è´¥:', error);
                    return {};
                });
        }
        
        // åŠ è½½è¯•é¢˜åˆ—è¡¨ï¼ˆæ”¯æŒåˆ†é¡µï¼‰
        function loadQuestions() {
            const loadingIndicator = document.getElementById('loadingIndicator');
            const questionTableBody = document.getElementById('questionTableBody');
            const emptyState = document.getElementById('emptyState');
            const paginationContainer = document.getElementById('paginationContainer');
            
            loadingIndicator.style.display = 'block';
            questionTableBody.innerHTML = '';
            paginationContainer.style.display = 'none';
            
            isSearchMode = false;
            
            // å…ˆåŠ è½½ä½œä¸šä¿¡æ¯æ˜ å°„
            loadAssignmentMap().then(() => {
                // ä½¿ç”¨fetch APIä»åç«¯è·å–åˆ†é¡µæ•°æ®
                fetch(`/question/refresh?page=${currentPage}&pageSize=${pageSize}`)
                    .then(response => response.json())
                    .then(data => {
                        loadingIndicator.style.display = 'none';
                        
                        if (data.success && data.data) {
                            const questions = data.data.list || data.data;
                            totalItems = data.data.total || questions.length;
                            totalPages = Math.ceil(totalItems / pageSize);
                            
                            if (questions && questions.length > 0) {
                                // éšè—ç©ºçŠ¶æ€
                                emptyState.style.display = 'none';
                                paginationContainer.style.display = 'block';
                                
                                // æ¸²æŸ“è¯•é¢˜åˆ—è¡¨
                                questions.forEach((question, index) => {
                                    const row = document.createElement('tr');
                                    
                                    // è¿ç®—ç¬¦æ ‡ç­¾
                                    let operatorTag = '';
                                    if (question.operator === '+') {
                                        operatorTag = '<span class="operator-tag add">åŠ æ³•</span>';
                                    } else if (question.operator === '-') {
                                        operatorTag = '<span class="operator-tag subtract">å‡æ³•</span>';
                                    } else if (question.operator === 'mixed') {
                                        operatorTag = '<span class="operator-tag mixed">æ··åˆè¿ç®—</span>';
                                    }
                                    
                                    // æ‰€å±ä½œä¸šæ˜¾ç¤ºï¼Œä½¿ç”¨ä½œä¸šåç§°ä»£æ›¿ID
                                    let assignmentInfo = question.assignmentId == null || question.assignmentId === 0 || !assignmentMap[question.assignmentId] ? 'æš‚æœªåˆ†é…' : assignmentMap[question.assignmentId];
                                    
                                    // è®¡ç®—æ­£ç¡®çš„é¢˜ç›®åºå·ï¼ˆè€ƒè™‘åˆ†é¡µï¼‰
                                    const questionNumber = (currentPage - 1) * pageSize + index + 1;
                                    
                                    row.innerHTML = `
                                        <td>${questionNumber}</td>
                                        <td>${question.question}</td>
                                        <td>${question.answer}</td>
                                        <td>${operatorTag}</td>
                                        <td>${assignmentInfo}</td>
                                        <td>
                                            <button class="btn btn-danger" onclick="showDeleteModal(${question.id})">åˆ é™¤</button>
                                        </td>
                                    `;
                                    
                                    questionTableBody.appendChild(row);
                                });
                                
                                // æ›´æ–°åˆ†é¡µä¿¡æ¯
                                updatePagination();
                            } else {
                                // æ˜¾ç¤ºç©ºçŠ¶æ€
                                emptyState.style.display = 'block';
                            }
                        } else {
                            // æ˜¾ç¤ºç©ºçŠ¶æ€
                            emptyState.style.display = 'block';
                        }
                    })
                    .catch(error => {
                        console.error('åŠ è½½è¯•é¢˜åˆ—è¡¨å¤±è´¥:', error);
                        loadingIndicator.style.display = 'none';
                        emptyState.style.display = 'block';
                    });
            });
        }
        
        // æœç´¢è¯•é¢˜ï¼ˆæ”¯æŒåˆ†é¡µï¼‰
        function searchQuestions() {
            const keyword = document.getElementById('searchKeyword').value.trim();
            const loadingIndicator = document.getElementById('loadingIndicator');
            const questionTableBody = document.getElementById('questionTableBody');
            const emptyState = document.getElementById('emptyState');
            const paginationContainer = document.getElementById('paginationContainer');
            
            if (!keyword) {
                currentPage = 1;
                loadQuestions();
                return;
            }
            
            loadingIndicator.style.display = 'block';
            questionTableBody.innerHTML = '';
            paginationContainer.style.display = 'none';
            
            isSearchMode = true;
            searchKeyword = keyword;
            
            // ä½¿ç”¨fetch APIä»åç«¯è·å–åˆ†é¡µæœç´¢æ•°æ®
            fetch(`/question/search?keyword=${encodeURIComponent(keyword)}&page=${currentPage}&pageSize=${pageSize}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                loadingIndicator.style.display = 'none';
                
                if (data.success && data.data) {
                    const questions = data.data.list || data.data;
                    totalItems = data.data.total || questions.length;
                    totalPages = Math.ceil(totalItems / pageSize);
                    
                    if (questions && questions.length > 0) {
                        emptyState.style.display = 'none';
                        paginationContainer.style.display = 'block';
                        
                        questions.forEach((question, index) => {
                            const row = document.createElement('tr');
                            
                            let operatorTag = '';
                            if (question.operator === '+') {
                                operatorTag = '<span class="operator-tag add">åŠ æ³•</span>';
                            } else if (question.operator === '-') {
                                operatorTag = '<span class="operator-tag subtract">å‡æ³•</span>';
                            } else if (question.operator === 'mixed') {
                                operatorTag = '<span class="operator-tag mixed">æ··åˆè¿ç®—</span>';
                            }
                           // æ‰€å±ä½œä¸šæ˜¾ç¤ºï¼Œä½¿ç”¨ä½œä¸šåç§°ä»£æ›¿ID
                            let assignmentInfo = question.assignmentId === 0 || question.assignmentId == null || !assignmentMap[question.assignmentId] ? 'æš‚æœªåˆ†é…' : assignmentMap[question.assignmentId];
                            
                            // è®¡ç®—æ­£ç¡®çš„é¢˜ç›®åºå·ï¼ˆè€ƒè™‘åˆ†é¡µï¼‰
                            const questionNumber = (currentPage - 1) * pageSize + index + 1;
                            
                            row.innerHTML = `
                                <td>${questionNumber}</td>
                                <td>${question.question}</td>
                                <td>${question.answer}</td>
                                <td>${operatorTag}</td>
                                <td>${assignmentInfo}</td>
                                <td>
                                    <button class="btn btn-danger" onclick="showDeleteModal(${question.id})"></button>
                                </td>
                            `;
                            
                            questionTableBody.appendChild(row);
                        });
                        
                        // æ›´æ–°åˆ†é¡µä¿¡æ¯
                        updatePagination();
                    } else {
                        emptyState.style.display = 'block';
                        emptyState.innerHTML = `
                            <div class="icon">ğŸ”</div>
                            <h3>æœªæ‰¾åˆ°ç›¸å…³è¯•é¢˜</h3>
                            <p>æ²¡æœ‰æ‰¾åˆ°åŒ…å«"${keyword}"çš„è¯•é¢˜ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯</p>
                        `;
                    }
                } else {
                    emptyState.style.display = 'block';
                    emptyState.innerHTML = `
                        <div class="icon">ğŸ”</div>
                        <h3>æœªæ‰¾åˆ°ç›¸å…³è¯•é¢˜</h3>
                        <p>æ²¡æœ‰æ‰¾åˆ°åŒ…å«"${keyword}"çš„è¯•é¢˜ï¼Œè¯·å°è¯•å…¶ä»–å…³é”®è¯</p>
                    `;
                }
            })
            .catch(error => {
                console.error('æœç´¢è¯•é¢˜å¤±è´¥:', error);
                loadingIndicator.style.display = 'none';
            });
        }
        
        // åˆ·æ–°è¯•é¢˜åˆ—è¡¨
        function refreshQuestions() {
            document.getElementById('searchKeyword').value = '';
            currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            isSearchMode = false;
            searchKeyword = '';
            loadQuestions();
        }
        
        // æ›´æ–°åˆ†é¡µæ§ä»¶
        function updatePagination() {
            const totalItemsElem = document.getElementById('totalItems');
            const currentPageElem = document.getElementById('currentPage');
            const totalPagesElem = document.getElementById('totalPages');
            const prevPageBtn = document.getElementById('prevPage');
            const nextPageBtn = document.getElementById('nextPage');
            const pageNumbersDiv = document.getElementById('pageNumbers');
            
            // æ›´æ–°åˆ†é¡µä¿¡æ¯æ–‡æœ¬
            totalItemsElem.textContent = totalItems;
            currentPageElem.textContent = currentPage;
            totalPagesElem.textContent = totalPages;
            
            // æ›´æ–°ä¸Šä¸€é¡µ/ä¸‹ä¸€é¡µæŒ‰é’®çŠ¶æ€
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
            
            // ç”Ÿæˆé¡µç æŒ‰é’®
            pageNumbersDiv.innerHTML = '';
            
            // è®¡ç®—éœ€è¦æ˜¾ç¤ºçš„é¡µç èŒƒå›´
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + 4);
            
            // è°ƒæ•´èµ·å§‹é¡µç ï¼Œç¡®ä¿æ˜¾ç¤º5ä¸ªé¡µç 
            if (endPage - startPage < 4) {
                startPage = Math.max(1, endPage - 4);
            }
            
            // æ·»åŠ é¦–é¡µæŒ‰é’®
            if (startPage > 1) {
                addPageButton(1);
                if (startPage > 2) {
                    addEllipsis();
                }
            }
            
            // æ·»åŠ ä¸­é—´é¡µç æŒ‰é’®
            for (let i = startPage; i <= endPage; i++) {
                addPageButton(i);
            }
            
            // æ·»åŠ æœ«é¡µæŒ‰é’®
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    addEllipsis();
                }
                addPageButton(totalPages);
            }
        }
        
        // æ·»åŠ é¡µç æŒ‰é’®
        function addPageButton(pageNum) {
            const pageNumbersDiv = document.getElementById('pageNumbers');
            const button = document.createElement('button');
            button.className = 'btn btn-sm page-btn';
            if (pageNum === currentPage) {
                button.classList.add('active');
                button.disabled = true;
            }
            button.textContent = pageNum;
            button.onclick = () => {
                currentPage = pageNum;
                if (isSearchMode) {
                    searchQuestions();
                } else {
                    loadQuestions();
                }
            };
            pageNumbersDiv.appendChild(button);
        }
        
        // æ·»åŠ çœç•¥å·
        function addEllipsis() {
            const pageNumbersDiv = document.getElementById('pageNumbers');
            const ellipsis = document.createElement('span');
            ellipsis.className = 'page-ellipsis';
            ellipsis.textContent = '...';
            ellipsis.style.margin = '0 5px';
            pageNumbersDiv.appendChild(ellipsis);
        }
        
        // åˆ‡æ¢é¡µé¢ï¼ˆ-1: ä¸Šä¸€é¡µ, 1: ä¸‹ä¸€é¡µï¼‰
        function changePage(direction) {
            const newPage = currentPage + direction;
            if (newPage >= 1 && newPage <= totalPages) {
                currentPage = newPage;
                if (isSearchMode) {
                    searchQuestions();
                } else {
                    loadQuestions();
                }
            }
        }
        
        // æ”¹å˜æ¯é¡µæ˜¾ç¤ºæ•°é‡
        function changePageSize() {
            const pageSizeSelect = document.getElementById('pageSize');
            pageSize = parseInt(pageSizeSelect.value);
            currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
            
            if (isSearchMode) {
                searchQuestions();
            } else {
                loadQuestions();
            }
        }
        
        // ç”Ÿæˆéšæœºè¯•é¢˜
        function generateRandomQuestions() {
            const count = document.getElementById('questionCount').value;
            const operator = document.getElementById('operatorType').value;
            const min = document.getElementById('numberMin').value;
            const max = document.getElementById('numberMax').value;
            
            // éªŒè¯è¾“å…¥
            if (parseInt(min) >= parseInt(max)) {
                alert('æœ€å°å€¼å¿…é¡»å°äºæœ€å¤§å€¼');
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const generateResult = document.getElementById('generateResult');
            const generatedQuestionsPreview = document.getElementById('generatedQuestionsPreview');
            generatedQuestionsPreview.innerHTML = '<div class="loading">æ­£åœ¨ç”Ÿæˆè¯•é¢˜...</div>';
            generateResult.style.display = 'block';
            
            // å‘é€è¯·æ±‚
            fetch(`/question/generate?count=${count}&operator=${operator}&min=${min}&max=${max}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // ä¿å­˜ç”Ÿæˆçš„è¯•é¢˜æ•°æ®åˆ°é¡µé¢ï¼Œä¾›åç»­ä¿å­˜ä½¿ç”¨
                    window.generatedQuestions = data.data;
                    
                    // æ˜¾ç¤ºç”Ÿæˆçš„è¯•é¢˜é¢„è§ˆï¼ˆæ¯è¡Œ6ä¸ªï¼Œç›´æ¥æ˜¾ç¤ºç­”æ¡ˆï¼‰
                    let previewHtml = '<div class="card" style="margin-top: 20px;">';
                    previewHtml += '<div class="card-header" style="margin-bottom: 0;">ç”Ÿæˆçš„è¯•é¢˜åˆ—è¡¨</div>';
                    previewHtml += '<div style="padding: 20px;">';
                    previewHtml += `<p>æˆåŠŸç”Ÿæˆ ${data.data.length} é“è¯•é¢˜</p>`;
                    
                    // åˆ›å»ºç½‘æ ¼å¸ƒå±€æ˜¾ç¤ºè¯•é¢˜
                    previewHtml += '<div style="display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 20px;">';
                    
                    data.data.forEach((question) => {
                        // å°†é—®é¢˜æ ¼å¼åŒ–ä¸º "5 + 3 = 8" å½¢å¼
                        const questionText = question.question.replace(' = ?', ` = ${question.answer}`);
                        previewHtml += `<div style="padding: 10px; border: 1px solid #eee; border-radius: 4px; text-align: center;">${questionText}</div>`;
                    });
                    
                    previewHtml += '</div>';
                    
                    previewHtml += '<div class="text-center mt-4">';
                    previewHtml += '<button class="btn" onclick="saveGeneratedQuestions()">ä¿å­˜è¯•é¢˜</button>';
                    previewHtml += '<button class="btn btn-secondary ml-2" onclick="exportQuestionsToCSV()">å¯¼å‡ºè¯•é¢˜</button>';
                    previewHtml += '</div>';
                    previewHtml += '</div>';
                    previewHtml += '</div>';
                    
                    generatedQuestionsPreview.innerHTML = previewHtml;
                } else {
                    generatedQuestionsPreview.innerHTML = `<div class="alert alert-danger">ç”Ÿæˆå¤±è´¥ï¼š${data.message}</div>`;
                }
            })
            .catch(error => {
                console.error('ç”Ÿæˆè¯•é¢˜å¤±è´¥:', error);
                generatedQuestionsPreview.innerHTML = '<div class="alert alert-danger">ç”Ÿæˆå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            });
        }
        
        // ä¿å­˜ç”Ÿæˆçš„è¯•é¢˜åˆ°æ•°æ®åº“
        function saveGeneratedQuestions() {
            if (!window.generatedQuestions || window.generatedQuestions.length === 0) {
                alert('æ²¡æœ‰å¯ä¿å­˜çš„è¯•é¢˜');
                return;
            }
            
            const generatedQuestionsPreview = document.getElementById('generatedQuestionsPreview');
            generatedQuestionsPreview.innerHTML = '<div class="loading">æ­£åœ¨ä¿å­˜è¯•é¢˜...</div>';
            
            // å‘é€ä¿å­˜è¯·æ±‚
            fetch('/question/saveGenerated', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    questions: window.generatedQuestions
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    generatedQuestionsPreview.innerHTML = `
                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header" style="margin-bottom: 0; background-color: #dff0d8; color: #3c763d;">
                                ä¿å­˜æˆåŠŸ
                            </div>
                            <div style="padding: 20px;">
                                <p>æˆåŠŸä¿å­˜ ${data.data} é“è¯•é¢˜</p>
                                <div class="text-center mt-4">
                                    <button class="btn" onclick="loadQuestions(); switchToQuestionList();">æŸ¥çœ‹æ‰€æœ‰è¯•é¢˜</button>
                                </div>
                            </div>
                        </div>
                    `;
                    // æ¸…ç©ºç”Ÿæˆçš„è¯•é¢˜æ•°æ®
                    window.generatedQuestions = null;
                } else {
                    generatedQuestionsPreview.innerHTML = `<div class="alert alert-danger">ä¿å­˜å¤±è´¥ï¼š${data.message}</div>`;
                }
            })
            .catch(error => {
                console.error('ä¿å­˜è¯•é¢˜å¤±è´¥:', error);
                generatedQuestionsPreview.innerHTML = '<div class="alert alert-danger">ä¿å­˜å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            });
        }
        
        // æ‰‹åŠ¨æ·»åŠ è¯•é¢˜
        function addManualQuestion() {
            const question = document.getElementById('questionContent').value.trim();
            const answer = document.getElementById('questionAnswer').value;
            const operator = document.getElementById('questionOperator').value;
            
            // éªŒè¯è¾“å…¥
            if (!question) {
                alert('è¯·è¾“å…¥é¢˜ç›®å†…å®¹');
                return;
            }
            
            if (!answer) {
                alert('è¯·è¾“å…¥æ­£ç¡®ç­”æ¡ˆ');
                return;
            }
            
            // å‘é€è¯·æ±‚
            fetch(`/question/add?question=${encodeURIComponent(question)}&answer=${answer}&operator=${operator}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('è¯•é¢˜æ·»åŠ æˆåŠŸ');
                    // æ¸…ç©ºè¡¨å•
                    document.getElementById('addQuestionForm').reset();
                    // åŠ è½½æœ€æ–°è¯•é¢˜åˆ—è¡¨
                    loadQuestions();
                } else {
                    alert('æ·»åŠ å¤±è´¥ï¼š' + data.message);
                }
            })
            .catch(error => {
                console.error('æ·»åŠ è¯•é¢˜å¤±è´¥:', error);
                alert('æ·»åŠ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        }
        
        // æ˜¾ç¤ºåˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
        function showDeleteModal(id) {
            currentQuestionId = id;
            document.getElementById('deleteModal').style.display = 'block';
        }
        
        // å…³é—­åˆ é™¤ç¡®è®¤æ¨¡æ€æ¡†
        function closeDeleteModal() {
            currentQuestionId = null;
            document.getElementById('deleteModal').style.display = 'none';
        }
        
        // ç¡®è®¤åˆ é™¤è¯•é¢˜
        function confirmDelete() {
            if (!currentQuestionId) return;
            
            fetch(`/question/delete/${currentQuestionId}`, {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                closeDeleteModal();
                if (data.success) {
                    alert('è¯•é¢˜åˆ é™¤æˆåŠŸ');
                    
                    // æ£€æŸ¥å½“å‰é¡µæ˜¯å¦è¿˜æœ‰æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›ä¸Šä¸€é¡µ
                    const questionTableBody = document.getElementById('questionTableBody');
                    const rows = questionTableBody.querySelectorAll('tr');
                    
                    // å¦‚æœå½“å‰é¡µåªæœ‰ä¸€æ¡æ•°æ®ä¸”ä¸æ˜¯ç¬¬ä¸€é¡µï¼Œåˆ™åˆ é™¤åè¿”å›ä¸Šä¸€é¡µ
                    if (rows.length === 1 && currentPage > 1) {
                        currentPage--;
                    }
                    
                    // æ ¹æ®å½“å‰æ¨¡å¼åˆ·æ–°æ•°æ®
                    if (isSearchMode) {
                        searchQuestions();
                    } else {
                        loadQuestions();
                    }
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + data.message);
                }
            })
            .catch(error => {
                console.error('åˆ é™¤è¯•é¢˜å¤±è´¥:', error);
                closeDeleteModal();
                alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
        }
        

        
        // åˆ‡æ¢åˆ°è¯•é¢˜åˆ—è¡¨é€‰é¡¹å¡
        function switchToQuestionList() {
            document.querySelectorAll('.nav-tabs button').forEach(btn => btn.classList.remove('active'));
            document.getElementById('questionList-tab').classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(pane => {
                pane.style.display = 'none';
            });
            document.getElementById('questionList').style.display = 'block';
        }
        

        

        
        // å¯¼å‡ºè¯•é¢˜ä¸ºCSVæ–‡ä»¶
        function exportQuestionsToCSV() {
            if (!window.generatedQuestions || window.generatedQuestions.length === 0) {
                alert('æ²¡æœ‰å¯å¯¼å‡ºçš„è¯•é¢˜');
                return;
            }
            
            // åˆ›å»ºCSVå†…å®¹ï¼Œç¬¬ä¸€è¡Œä¸ºè¡¨å¤´
            let csvContent = 'expression\n';
            
            // æ·»åŠ æ¯ä¸ªè¯•é¢˜çš„è¡¨è¾¾å¼
            window.generatedQuestions.forEach(question => {
                // å°†é—®é¢˜æ ¼å¼åŒ–ä¸º "12+34=46" å½¢å¼ï¼Œå¹¶ç§»é™¤ç©ºæ ¼
                const expression = question.question.replace(' = ?', ` = ${question.answer}`).replace(/\s+/g, '');
                csvContent += expression + '\n';
            });
            
            // åˆ›å»ºBlobå¯¹è±¡
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            // è®¾ç½®æ–‡ä»¶å
            const filename = `questions_${new Date().getTime()}.csv`;
            
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>