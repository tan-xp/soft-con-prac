<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>考试详情 - 软工实践系统</title>
    <style>
        /* 全局样式重置 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft YaHei", "Hiragino Sans GB", SimSun, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        /* 头部样式 */
        .header {
            background-color: #fff;
            border-bottom: 1px solid #e9ecef;
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .header div:first-child {
            font-size: 20px;
            font-weight: bold;
            color: #3a8240;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .header-right a {
            color: #666;
            text-decoration: none;
            transition: color 0.3s;
        }

        .header-right a:hover {
            color: #50a354;
        }

        /* 导航栏样式 */
        .nav {
            background-color: #fff;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            padding: 0 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .nav a {
            padding: 15px 20px;
            color: #666;
            text-decoration: none;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }

        .nav a:hover {
            color: #50a354;
        }

        .nav a.active {
            color: #50a354;
            border-bottom-color: #50a354;
            font-weight: 500;
        }

        /* 容器样式 */
        .container {
            max-width: 1200px;
            margin: 20px auto;
            padding: 0 20px;
        }

        /* 标题样式 */
        .section-title {
            font-size: 18px;
            font-weight: bold;
            color: #3a8240;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #50a354;
        }

        /* 内容框样式 */
        .content-box {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            padding: 25px;
            margin-bottom: 20px;
        }

        /* 标题栏样式 */
        .title-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }

        .title-bar h2 {
            font-size: 22px;
            color: #333;
        }

        .actions {
            display: flex;
            gap: 10px;
        }

        /* 按钮样式 */
        .btn {
            display: inline-block;
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            text-decoration: none;
            transition: all 0.3s;
        }

        .btn-primary {
            background-color: #50a354;
            color: white;
        }

        .btn-primary:hover {
            background-color: #3a8240;
        }

        .btn-success {
            background-color: #28a745;
            color: white;
        }

        .btn-success:hover {
            background-color: #218838;
        }

        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-warning:hover {
            background-color: #e0a800;
        }

        .btn-danger {
            background-color: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        /* 信息展示样式 */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .info-item {
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 6px;
            border-left: 4px solid #50a354;
        }

        .info-label {
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }

        .info-value {
            font-size: 16px;
            font-weight: 500;
            color: #333;
        }

        /* 状态标签样式 */
        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            font-weight: bold;
        }

        .status-upcoming {
            background-color: #50a354;
            color: white;
        }

        .status-ongoing {
            background-color: #e74c3c;
            color: white;
        }

        .status-ended {
            background-color: #95a5a6;
            color: white;
        }

        /* 试卷信息样式 */
        .paper-info {
            background-color: #f0f9f0;
            padding: 20px;
            border-radius: 6px;
            margin-bottom: 20px;
            border-left: 4px solid #50a354;
        }

        .paper-info h4 {
            color: #3a8240;
            margin-bottom: 15px;
            font-size: 16px;
        }

        /* 试题列表样式 */
        .questions-section {
            margin-top: 30px;
        }

        .questions-list {
            margin-top: 15px;
        }

        .question-item {
            padding: 15px;
            background-color: #f0f9f0;
            border-radius: 6px;
            margin-bottom: 10px;
            border-left: 4px solid #50a354;
            transition: box-shadow 0.3s;
        }

        .question-item:hover {
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .question-number {
            font-weight: bold;
            color: #3a8240;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .question-content {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-bottom: 8px;
        }

        .option {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            background-color: white;
            transition: border-color 0.3s;
        }

        .option:hover {
            border-color: #50a354;
        }

        .answer {
            font-weight: bold;
            color: #e74c3c;
            margin-top: 8px;
        }

        /* 空状态样式 */
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #999;
        }

        .empty-state i {
            font-size: 48px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        .empty-message {
            text-align: center;
            padding: 30px;
            color: #7f8c8d;
            font-style: italic;
        }

        /* 加载状态样式 */
        .loading {
            text-align: center;
            padding: 30px;
            color: #50a354;
            font-size: 16px;
        }

        /* Toast通知样式 */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 20px;
            border-radius: 4px;
            color: white;
            font-size: 14px;
            z-index: 1000;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateX(100%);
            transition: opacity 0.3s, transform 0.3s;
        }

        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }

        .toast.success {
            background-color: #50a354;
        }

        .toast.error {
            background-color: #e74c3c;
        }

        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e8e8e8;
        }

        .modal-header h3 {
            color: #3a8240;
            font-size: 18px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: #333;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #e8e8e8;
        }
    </style>
</head>
<body>
    <div class="header">
        <div>软工实践系统</div>
        <div class="header-right">
            <span>欢迎，${teacher?.teacherName}</span>
            <a href="/logout">退出</a>
        </div>
    </div>

    <div class="nav">
        <a href="/index">首页</a>
        <a href="/student/list">学生管理</a>
        <a href="/assignment/list">作业管理</a>
        <a href="/exam/list" class="active">考试管理</a>
        <a href="/question/list">试题管理</a>
        <a href="/score/list">成绩统计</a>
    </div>

    <div class="container">
        <div class="content-box">
            <div class="title-bar">
                <h2 id="examTitle">考试详情</h2>
                <div class="actions">
                    <a href="/exam/list" class="btn btn-primary">返回列表</a>
                    <a href="/exam/edit/" id="editBtn" class="btn btn-warning">编辑</a>
                    <button id="deleteBtn" class="btn btn-danger">删除考试</button>
                    <button id="updateStatusBtn" class="btn btn-success">更新状态</button>
                </div>
            </div>

            <!-- 考试基本信息 -->
            <div id="examInfo" class="loading">加载中...</div>

            <!-- 试卷信息 -->
            <div class="paper-info">
                <h4>试卷信息</h4>
                <div id="paperInfo" class="loading">加载中...</div>
            </div>

            <!-- 试题列表 -->
            <div class="questions-section">
                <div class="section-title">试题列表</div>
                <div id="questionsList" class="loading">加载中...</div>
            </div>
        </div>
    </div>

    <!-- 更新状态模态框 -->
    <div id="statusModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>更新考试状态</h3>
                <button class="close-modal" onclick="closeStatusModal()">×</button>
            </div>
            <div>
                <label for="statusSelect">选择新状态：</label>
                <select id="statusSelect" style="width: 100%; padding: 8px; margin-top: 10px; border-radius: 4px; border: 1px solid #ddd;">
                    <option value="upcoming">即将开始</option>
                    <option value="ongoing">进行中</option>
                    <option value="ended">已结束</option>
                </select>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="confirmUpdateStatus()">确认更新</button>
                <button class="btn btn-warning" onclick="closeStatusModal()">取消</button>
            </div>
        </div>
    </div>

    <script src="/js/axios.min.js"></script>
    <script src="/js/exam-service.js"></script>
<script src="/js/form-validation-helper.js"></script>
<script src="/js/page-test-helper.js"></script>
<script>
        let examId = null;
        let examData = null;

        // 获取URL中的考试ID
        function getExamIdFromUrl() {
            const urlParts = window.location.pathname.split('/');
            return urlParts[urlParts.length - 1];
        }

        // 页面加载时初始化
        window.onload = function() {
            // 测试辅助函数，用于开发测试
            if (window.PageTestHelper) {
                const testData = window.PageTestHelper.getTestData('examDetail');
                if (testData) {
                    examId = testData.id || getExamIdFromUrl();
                    document.getElementById('editBtn').href = `/exam/edit/${examId}`;
                    examData = testData;
                    renderExamInfo();
                    renderPaperInfo();
                    renderQuestionsList();
                    return;
                }
            }
            
            // 正常流程
            examId = getExamIdFromUrl();
            if (examId) {
                document.getElementById('editBtn').href = `/exam/edit/${examId}`;
                showLoading(true);
                fetchExamDetails();
            } else {
                showToast('无法获取考试ID', 'error');
            }
        };

        // 获取考试详情
        function fetchExamDetails() {
            if (!examService || !examService.getExamById) {
                handleError(new Error('考试服务未加载'));
                showLoading(false);
                return;
            }
            
            examService.getExamById(examId)
                .then(result => {
                    if (result.success) {
                        examData = result.data;
                        renderExamInfo();
                        renderPaperInfo();
                        renderQuestionsList();
                    } else {
                        throw new Error(result.message || '获取考试详情失败');
                    }
                })
                .catch(handleError)
                .finally(() => showLoading(false));
        }

        // 渲染考试基本信息
        function renderExamInfo() {
            if (!examData) return;
            
            const examInfo = document.getElementById('examInfo');
            
            // 确定状态类名和文本
            let statusClass = 'status-ended';
            let statusText = '已结束';
            const now = new Date();
            const startTime = new Date(examData.startTime);
            const endTime = new Date(examData.endTime);
            
            if (now < startTime) {
                statusClass = 'status-upcoming';
                statusText = '即将开始';
            } else if (now >= startTime && now <= endTime) {
                statusClass = 'status-ongoing';
                statusText = '进行中';
            }

            examInfo.innerHTML = `
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">考试ID</div>
                        <div class="info-value">${examData.id}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">考试标题</div>
                        <div class="info-value" id="examTitleDisplay">${examData.title || '未设置标题'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">考试状态</div>
                        <div class="info-value"><span class="status-badge ${statusClass}">${statusText}</span></div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">创建教师</div>
                        <div class="info-value">${examData.teacherName || '未知'}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">开始时间</div>
                        <div class="info-value">${formatDate(examData.startTime)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">结束时间</div>
                        <div class="info-value">${formatDate(examData.endTime)}</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">考试时长</div>
                        <div class="info-value">${examData.duration || 0} 分钟</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">试卷ID</div>
                        <div class="info-value">${examData.paperId || '未设置'}</div>
                    </div>
                </div>
                <div style="margin-top: 20px;">
                    <div class="info-label">考试描述</div>
                    <div class="info-value" style="background-color: #f8f9fa; padding: 15px; border-radius: 6px;">${examData.description || '暂无描述'}</div>
                </div>
            `;

            // 更新页面标题
            document.getElementById('examTitle').textContent = `考试详情 - ${examData.title || '未命名考试'}`;
        }

        // 渲染试卷信息
        function renderPaperInfo() {
            if (!examData) return;
            
            const paperInfo = document.getElementById('paperInfo');
            
            if (examData.paper) {
                paperInfo.innerHTML = `
                    <div><strong>试卷标题：</strong>${examData.paper.title}</div>
                    <div><strong>试题数量：</strong>${examData.paper.totalQuestions || 0} 题</div>
                    <div><strong>难度：</strong>${examData.paper.difficulty || '未设置'}</div>
                    <div><strong>创建时间：</strong>${formatDate(examData.paper.createdAt)}</div>
                `;
            } else {
                paperInfo.innerHTML = '<div class="empty-state">暂无试卷信息</div>';
            }
        }

        // 渲染试题列表
        function renderQuestionsList() {
            if (!examData) return;
            
            const questionsList = document.getElementById('questionsList');
            
            if (examData.questions && examData.questions.length > 0) {
                let html = '';
                examData.questions.forEach((question, index) => {
                    if (!question) return;
                    
                    html += `
                        <div class="question-item">
                            <div class="question-number">第 ${index + 1} 题</div>
                            <div class="question-content">${question.question || '无题目内容'}</div>
                            <div class="options">
                                <div class="option">A. ${question.optionA || '未设置'}</div>
                                <div class="option">B. ${question.optionB || '未设置'}</div>
                                <div class="option">C. ${question.optionC || '未设置'}</div>
                                <div class="option">D. ${question.optionD || '未设置'}</div>
                            </div>
                            <div class="answer">正确答案：${getOptionLetter(question.answer)}</div>
                        </div>
                    `;
                });
                questionsList.innerHTML = html;
            } else {
                questionsList.innerHTML = '<div class="empty-state">暂无试题信息</div>';
            }
        }

        // 获取选项字母
        function getOptionLetter(answerIndex) {
            const options = ['', 'A', 'B', 'C', 'D'];
            return options[answerIndex] || '未设置';
        }

        // 删除考试
        document.getElementById('deleteBtn').onclick = function() {
            if (confirm('确定要删除这个考试吗？删除后无法恢复。')) {
                showLoading(true);
                
                if (!examService || !examService.deleteExam) {
                    handleError(new Error('考试服务未加载'));
                    showLoading(false);
                    return;
                }
                
                examService.deleteExam(examId)
                    .then(result => {
                        if (result.success) {
                            showToast('删除成功', 'success');
                            setTimeout(() => {
                                window.location.href = '/exam/list';
                            }, 1500);
                        } else {
                            throw new Error(result.message || '删除失败');
                        }
                    })
                    .catch(handleError)
                    .finally(() => showLoading(false));
            }
        };
        
        // 显示加载状态
        function showLoading(show) {
            const loadingElements = document.querySelectorAll('.loading');
            loadingElements.forEach(element => {
                element.style.display = show ? 'block' : 'none';
            });
        }
        
        // 错误处理函数
        function handleError(error) {
            console.error('错误:', error);
            // 错误消息会通过FormValidationHelper自动显示
            if (window.FormValidationHelper && typeof FormValidationHelper.showFormError === 'function' && !error.response?.data?.message) {
                FormValidationHelper.showFormError('操作失败: ' + (error.message || '未知错误'));
            } else {
                showToast(error.message || '操作失败', 'error');
            }
        }

        // 显示Toast通知
        function showToast(message, type = 'success') {
            // 检查是否已存在toast元素
            let toast = document.querySelector('.toast');
            if (toast) {
                document.body.removeChild(toast);
            }

            // 创建新的toast元素
            toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            document.body.appendChild(toast);

            // 显示toast
            setTimeout(() => {
                toast.classList.add('show');
            }, 10);

            // 3秒后隐藏
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    if (document.body.contains(toast)) {
                        document.body.removeChild(toast);
                    }
                }, 300);
            }, 3000);
        }

        // 打开状态更新模态框
        document.getElementById('updateStatusBtn').onclick = function() {
            document.getElementById('statusModal').style.display = 'flex';
        };

        // 关闭状态更新模态框
        function closeStatusModal() {
            document.getElementById('statusModal').style.display = 'none';
        }

        // 确认更新状态
        function confirmUpdateStatus() {
            const newStatus = document.getElementById('statusSelect').value;
            
            // 获取状态名称
            function getStatusName(status) {
                const statusMap = {
                    'upcoming': '即将开始',
                    'ongoing': '进行中',
                    'ended': '已结束'
                };
                return statusMap[status] || status;
            }
            
            if (!confirm(`确定要将考试状态更改为${getStatusName(newStatus)}吗？`)) {
                return;
            }
            
            showLoading(true);
            
            if (!examService || !examService.updateExamStatus) {
                handleError(new Error('考试服务未加载'));
                showLoading(false);
                closeStatusModal();
                return;
            }
            
            examService.updateExamStatus(examId, newStatus)
                .then(response => {
                    if (response && response.success) {
                        showToast('考试状态更新成功！', 'success');
                        // 1秒后重新加载页面以显示更新后的状态
                        setTimeout(() => {
                            closeStatusModal();
                            fetchExamDetails();
                        }, 1000);
                    } else {
                        throw new Error(response?.message || '更新状态失败');
                    }
                })
                .catch(error => {
                    handleError(error);
                    closeStatusModal();
                })
                .finally(() => {
                    showLoading(false);
                });
        }

        // 格式化日期
        function formatDate(dateString) {
            if (!dateString) return '';
            try {
                const date = new Date(dateString);
                return date.toLocaleString('zh-CN', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch (e) {
                console.error('日期格式化错误:', e);
                return dateString;
            }
        }
        
        // 点击模态框外部关闭模态框
        window.onclick = function(event) {
            const modal = document.getElementById('statusModal');
            if (event.target === modal) {
                closeStatusModal();
            }
        }
    </script>
</body>
</html>